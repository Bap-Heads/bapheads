<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clan Collection Log HiScores</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Bap Heads Collection Log HiScores</h1>
    <table>
        <thead>
            <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Collection Log Score</th>
            </tr>
        </thead>
        <tbody id="hiscores-table">
            <!-- Data will be inserted here -->
        </tbody>
    </table>

    <script>
        // Helper function to delay execution
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fetchClanHiscores() {
            try {
                // Fetch group data
                const groupResponse = await fetch("https://api.wiseoldman.net/v2/groups/5474");
                if (!groupResponse.ok) {
                    throw new Error(`HTTP error! Status: ${groupResponse.status}`);
                }
                const groupData = await groupResponse.json();

                // Extract member usernames
                const members = groupData.memberships.map(member => member.player.username);

                // Fetch collection log data for each member with rate limiting
                const hiscores = [];
                for (let i = 0; i < members.length; i++) {
                    const username = members[i];
                    try {
                        const logResponse = await fetch(`https://api.wiseoldman.net/v2/players/${username}/collection-log`);
                        if (!logResponse.ok) {
                            throw new Error(`HTTP error! Status: ${logResponse.status}`);
                        }
                        const logData = await logResponse.json();
                        hiscores.push({
                            username: username,
                            score: logData.totalObtained
                        });
                    } catch (error) {
                        console.error(`Error fetching collection log for ${username}:`, error);
                        hiscores.push({
                            username: username,
                            score: "N/A"
                        });
                    }

                    // Add a delay between requests to avoid rate limiting
                    if (i < members.length - 1) {
                        await delay(70000); // 1 second delay between requests
                    }
                }

                // Sort by collection log score (descending)
                hiscores.sort((a, b) => (b.score === "N/A" ? -1 : a.score === "N/A" ? 1 : b.score - a.score));

                // Generate the HTML table rows
                let tableRows = "";
                hiscores.forEach((entry, index) => {
                    tableRows += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${entry.username}</td>
                            <td>${entry.score}</td>
                        </tr>
                    `;
                });

                // Insert into the table
                document.getElementById("hiscores-table").innerHTML = tableRows;
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById("hiscores-table").innerHTML = `
                    <tr>
                        <td colspan="3">Failed to load data. Please try again later.</td>
                    </tr>
                `;
            }
        }

        fetchClanHiscores();
    </script>
</body>
</html>
